#!/bin/bash

# –°–∫—Ä–∏–ø—Ç —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./scripts/backup-db.sh <server-ip>

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
if [ -z "$1" ]; then
    echo -e "${RED}‚ùå –£–∫–∞–∂–∏—Ç–µ IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞${NC}"
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <server-ip>"
    echo "–ü—Ä–∏–º–µ—Ä: $0 51.250.12.34"
    exit 1
fi

SERVER_IP=$1
BACKUP_DIR="backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="database_${DATE}.db"

echo -e "${YELLOW}üîÑ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...${NC}"

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –±—ç–∫–∞–ø–æ–≤
mkdir -p "$BACKUP_DIR"

# –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞
echo "üì• –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ $SERVER_IP..."

# –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—É—Ç–∏
if ssh yc-user@$SERVER_IP "[ -f ~/creativity-bot/data/database.db ]"; then
    scp yc-user@$SERVER_IP:~/creativity-bot/data/database.db "$BACKUP_DIR/$BACKUP_FILE"
elif ssh yc-user@$SERVER_IP "docker exec creativity-bot test -f /app/data/database.db" 2>/dev/null; then
    # –ï—Å–ª–∏ –±–∞–∑–∞ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    echo "üì¶ –ë–∞–∑–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ, –∏–∑–≤–ª–µ–∫–∞–µ–º..."
    ssh yc-user@$SERVER_IP "docker cp creativity-bot:/app/data/database.db /tmp/database.db"
    scp yc-user@$SERVER_IP:/tmp/database.db "$BACKUP_DIR/$BACKUP_FILE"
    ssh yc-user@$SERVER_IP "rm /tmp/database.db"
else
    echo -e "${RED}‚ùå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ${NC}"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏
if [ -f "$BACKUP_DIR/$BACKUP_FILE" ]; then
    SIZE=$(du -h "$BACKUP_DIR/$BACKUP_FILE" | cut -f1)
    echo ""
    echo -e "${GREEN}‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!${NC}"
    echo "üìÅ –§–∞–π–ª: $BACKUP_DIR/$BACKUP_FILE"
    echo "üìè –†–∞–∑–º–µ—Ä: $SIZE"
    echo ""
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –±—ç–∫–∞–ø–æ–≤
    echo "üìã –í—Å–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏:"
    ls -lh "$BACKUP_DIR"
    
    # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10)
    BACKUP_COUNT=$(ls -1 "$BACKUP_DIR" | wc -l)
    if [ $BACKUP_COUNT -gt 10 ]; then
        echo ""
        echo -e "${YELLOW}üßπ –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10)...${NC}"
        cd "$BACKUP_DIR"
        ls -t | tail -n +11 | xargs rm -f
        cd ..
    fi
else
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏${NC}"
    exit 1
fi
